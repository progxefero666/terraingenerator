
import PromptEditor from "./controls/prompt-editor";

const defaultPrompt = `You are provided with an image that serves as a structural mask."`;


type TextureSidebarProps = {
    params: TextureParams;
    onParamsChange: (params: Partial<TextureParams>) => void;
    onAIGenerate: (prompt: string) => Promise<void>;
};


    useEffect(() => {
        const savedPrompt = sessionStorage.getItem('aiTexturePrompt');
        if (savedPrompt) {
            setAiPrompt(savedPrompt);
        }
    }, []);

    const [aiPrompt, setAiPrompt] = useState(defaultPrompt);
    const [isGenerating, setIsGenerating] = useState(false);
    const handlePromptSave = (newPrompt: string) => {
        setAiPrompt(newPrompt);
        sessionStorage.setItem('aiTexturePrompt', newPrompt);
    };

    const handleAIGenerate = async () => {
        // Extract just the user's description part for the AI flow
        const userDescriptionMatch = aiPrompt.match(/"(.*?)"/);
        const userDescription = userDescriptionMatch ? userDescriptionMatch[1] : aiPrompt;
        setIsGenerating(true);
        await onAIGenerate(userDescription);
        setIsGenerating(false);
    };

    const truncatePrompt = (prompt: string, length = 200) => {
        if (prompt.length <= length) return prompt;
        return prompt.substring(0, length) + "...";
    }

<AccordionItem value="ai-services">
    <div className="flex items-center w-full px-2 py-3">
        <AccordionTrigger className="text-lg font-semibold flex-1 text-left p-0 hover:no-underline">AI Services</AccordionTrigger>
        <div className="pl-2">
            <PromptEditor
                currentPrompt={aiPrompt}
                onSave={handlePromptSave}/>
        </div>
    </div>
    <AccordionContent className="px-2 space-y-2">
        <p className="text-sm text-muted-foreground italic leading-relaxed">
            {truncatePrompt(aiPrompt)}
        </p>
        <Button onClick={handleAIGenerate} disabled={isGenerating} className="w-full">
            <Wand2 className="mr-2 h-4 w-4" />
            {isGenerating ? "Generating..." : "Generate with AI"}
        </Button>
    </AccordionContent>
</AccordionItem>
